# prometheus/slo-recording-rules.yaml
# Recording rules for SLO calculations
# These pre-compute SLO metrics for efficient querying and dashboarding

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: transaction-api-slo-recording-rules
  namespace: monitoring
  labels:
    app: transaction-api
    prometheus: kube-prometheus
spec:
  groups:
    # ============================================
    # SLI RECORDING RULES
    # Service Level Indicators - Raw measurements
    # ============================================
    - name: transaction-api-sli
      interval: 30s
      rules:
        # HTTP Request Rate (Total)
        - record: sli:http_requests:rate5m
          expr: |
            sum(rate(http_requests_total{app="transaction-api"}[5m]))

        # HTTP Error Rate (5xx errors)
        - record: sli:http_requests_errors:rate5m
          expr: |
            sum(rate(http_requests_total{app="transaction-api",status=~"5.."}[5m]))

        # HTTP Success Rate (non-5xx)
        - record: sli:http_requests_success:rate5m
          expr: |
            sum(rate(http_requests_total{app="transaction-api",status!~"5.."}[5m]))

        # HTTP Request Duration P50
        - record: sli:http_request_duration:p50
          expr: |
            histogram_quantile(0.50,
              sum(rate(http_request_duration_seconds_bucket{app="transaction-api"}[5m])) by (le)
            )

        # HTTP Request Duration P95
        - record: sli:http_request_duration:p95
          expr: |
            histogram_quantile(0.95,
              sum(rate(http_request_duration_seconds_bucket{app="transaction-api"}[5m])) by (le)
            )

        # HTTP Request Duration P99
        - record: sli:http_request_duration:p99
          expr: |
            histogram_quantile(0.99,
              sum(rate(http_request_duration_seconds_bucket{app="transaction-api"}[5m])) by (le)
            )

        # Transaction Success Rate
        - record: sli:transactions_success:rate5m
          expr: |
            sum(rate(transactions_total{app="transaction-api",status="success"}[5m]))

        # Transaction Error Rate
        - record: sli:transactions_errors:rate5m
          expr: |
            sum(rate(transactions_total{app="transaction-api",status="failed"}[5m]))

        # Transaction Total Rate
        - record: sli:transactions:rate5m
          expr: |
            sum(rate(transactions_total{app="transaction-api"}[5m]))

        # Transaction Duration P95
        - record: sli:transaction_duration:p95
          expr: |
            histogram_quantile(0.95,
              sum(rate(transaction_processing_duration_seconds_bucket{app="transaction-api"}[5m])) by (le)
            )

        # Transaction Duration P99
        - record: sli:transaction_duration:p99
          expr: |
            histogram_quantile(0.99,
              sum(rate(transaction_processing_duration_seconds_bucket{app="transaction-api"}[5m])) by (le)
            )

        # Database Query Success Rate
        - record: sli:db_queries_success:rate5m
          expr: |
            sum(rate(db_queries_total{app="transaction-api"}[5m])) - 
            sum(rate(db_query_errors_total{app="transaction-api"}[5m]))

        # Database Query Error Rate
        - record: sli:db_queries_errors:rate5m
          expr: |
            sum(rate(db_query_errors_total{app="transaction-api"}[5m]))

    # ============================================
    # SLO RECORDING RULES
    # Service Level Objectives - Compliance metrics
    # ============================================
    - name: transaction-api-slo
      interval: 30s
      rules:
        # SLO 1: API Availability (99.95% target)
        # Error ratio over different time windows
        - record: slo:api_availability:error_ratio:5m
          expr: |
            sli:http_requests_errors:rate5m / sli:http_requests:rate5m

        - record: slo:api_availability:error_ratio:1h
          expr: |
            sum(rate(http_requests_total{app="transaction-api",status=~"5.."}[1h])) /
            sum(rate(http_requests_total{app="transaction-api"}[1h]))

        - record: slo:api_availability:error_ratio:6h
          expr: |
            sum(rate(http_requests_total{app="transaction-api",status=~"5.."}[6h])) /
            sum(rate(http_requests_total{app="transaction-api"}[6h]))

        - record: slo:api_availability:error_ratio:24h
          expr: |
            sum(rate(http_requests_total{app="transaction-api",status=~"5.."}[24h])) /
            sum(rate(http_requests_total{app="transaction-api"}[24h]))

        - record: slo:api_availability:error_ratio:7d
          expr: |
            sum(rate(http_requests_total{app="transaction-api",status=~"5.."}[7d])) /
            sum(rate(http_requests_total{app="transaction-api"}[7d]))

        - record: slo:api_availability:error_ratio:30d
          expr: |
            sum(rate(http_requests_total{app="transaction-api",status=~"5.."}[30d])) /
            sum(rate(http_requests_total{app="transaction-api"}[30d]))

        # API Availability success ratio (inverse of error ratio)
        - record: slo:api_availability:success_ratio:30d
          expr: |
            1 - slo:api_availability:error_ratio:30d

        # Error budget remaining for API Availability
        # Target: 99.95% availability = 0.05% error budget
        - record: slo:api_availability:error_budget_remaining:30d
          expr: |
            1 - (slo:api_availability:error_ratio:30d / 0.0005)

        # SLO 2: API Latency (P95 < 200ms, P99 < 500ms)
        # Percentage of requests meeting latency SLO
        - record: slo:api_latency_p95:success_ratio:5m
          expr: |
            (sli:http_request_duration:p95 <= 0.2)

        - record: slo:api_latency_p99:success_ratio:5m
          expr: |
            (sli:http_request_duration:p99 <= 0.5)

        # SLO 3: Transaction Success Rate (99.9% target)
        - record: slo:transaction_success:error_ratio:5m
          expr: |
            sli:transactions_errors:rate5m / sli:transactions:rate5m

        - record: slo:transaction_success:error_ratio:1h
          expr: |
            sum(rate(transactions_total{app="transaction-api",status="failed"}[1h])) /
            sum(rate(transactions_total{app="transaction-api"}[1h]))

        - record: slo:transaction_success:error_ratio:24h
          expr: |
            sum(rate(transactions_total{app="transaction-api",status="failed"}[24h])) /
            sum(rate(transactions_total{app="transaction-api"}[24h]))

        - record: slo:transaction_success:error_ratio:7d
          expr: |
            sum(rate(transactions_total{app="transaction-api",status="failed"}[7d])) /
            sum(rate(transactions_total{app="transaction-api"}[7d]))

        # Transaction success ratio
        - record: slo:transaction_success:success_ratio:7d
          expr: |
            1 - slo:transaction_success:error_ratio:7d

        # Error budget remaining for Transaction Success
        # Target: 99.9% success = 0.1% error budget
        - record: slo:transaction_success:error_budget_remaining:7d
          expr: |
            1 - (slo:transaction_success:error_ratio:7d / 0.001)

        # SLO 4: Transaction Processing Time (P95 < 2s, P99 < 5s)
        - record: slo:transaction_latency_p95:success_ratio:5m
          expr: |
            (sli:transaction_duration:p95 <= 2.0)

        - record: slo:transaction_latency_p99:success_ratio:5m
          expr: |
            (sli:transaction_duration:p99 <= 5.0)

        # SLO 5: Database Connection Availability (99.99% target)
        - record: slo:db_availability:error_ratio:5m
          expr: |
            sli:db_queries_errors:rate5m / 
            (sli:db_queries_success:rate5m + sli:db_queries_errors:rate5m)

        - record: slo:db_availability:error_ratio:24h
          expr: |
            sum(rate(db_query_errors_total{app="transaction-api"}[24h])) /
            sum(rate(db_queries_total{app="transaction-api"}[24h]))

        - record: slo:db_availability:success_ratio:24h
          expr: |
            1 - slo:db_availability:error_ratio:24h

        # Error budget remaining for DB Availability
        # Target: 99.99% availability = 0.01% error budget
        - record: slo:db_availability:error_budget_remaining:24h
          expr: |
            1 - (slo:db_availability:error_ratio:24h / 0.0001)

    # ============================================
    # ERROR BUDGET BURN RATE
    # Track how fast error budget is being consumed
    # ============================================
    - name: transaction-api-burn-rate
      interval: 30s
      rules:
        # Burn rate for different time windows
        # A burn rate of 1.0 means error budget will be exhausted in exactly 30 days
        # Burn rate > 1.0 means faster consumption
        
        # 1 hour burn rate
        - record: slo:api_availability:burn_rate:1h
          expr: |
            slo:api_availability:error_ratio:1h / 0.0005

        # 6 hour burn rate
        - record: slo:api_availability:burn_rate:6h
          expr: |
            slo:api_availability:error_ratio:6h / 0.0005

        # 24 hour burn rate
        - record: slo:api_availability:burn_rate:24h
          expr: |
            slo:api_availability:error_ratio:24h / 0.0005

        # 7 day burn rate
        - record: slo:api_availability:burn_rate:7d
          expr: |
            slo:api_availability:error_ratio:7d / 0.0005

        # Time to exhaustion (in days) at current 24h burn rate
        - record: slo:api_availability:time_to_exhaustion_days
          expr: |
            30 / (slo:api_availability:burn_rate:24h + 0.0001)

    # ============================================
    # BUSINESS METRICS
    # Additional metrics for business monitoring
    # ============================================
    - name: transaction-api-business-metrics
      interval: 60s
      rules:
        # Transaction volume by type
        - record: business:transactions_by_type:rate5m
          expr: |
            sum(rate(transactions_total{app="transaction-api"}[5m])) by (type)

        # Transaction volume by status
        - record: business:transactions_by_status:rate5m
          expr: |
            sum(rate(transactions_total{app="transaction-api"}[5m])) by (status)

        # Total transaction amount processed
        - record: business:transaction_amount:rate5m
          expr: |
            sum(rate(transaction_amount_total{app="transaction-api"}[5m]))

        # Average transaction processing time
        - record: business:transaction_duration:avg
          expr: |
            sum(rate(transaction_processing_duration_seconds_sum{app="transaction-api"}[5m])) /
            sum(rate(transaction_processing_duration_seconds_count{app="transaction-api"}[5m]))

        # Requests per second by endpoint
        - record: business:requests_by_endpoint:rate5m
          expr: |
            sum(rate(http_requests_total{app="transaction-api"}[5m])) by (endpoint, method)

        # Error rate by endpoint
        - record: business:error_rate_by_endpoint:ratio
          expr: |
            sum(rate(http_requests_total{app="transaction-api",status=~"5.."}[5m])) by (endpoint) /
            sum(rate(http_requests_total{app="transaction-api"}[5m])) by (endpoint)

    # ============================================
    # RESOURCE UTILIZATION
    # Track resource usage for capacity planning
    # ============================================
    - name: transaction-api-resources
      interval: 60s
      rules:
        # CPU utilization percentage
        - record: resource:cpu_utilization:percentage
          expr: |
            sum(rate(container_cpu_usage_seconds_total{namespace="default",pod=~"transaction-api-.*"}[5m])) by (pod) /
            sum(container_spec_cpu_quota{namespace="default",pod=~"transaction-api-.*"} / 100000) by (pod) * 100

        # Memory utilization percentage
        - record: resource:memory_utilization:percentage
          expr: |
            sum(container_memory_working_set_bytes{namespace="default",pod=~"transaction-api-.*"}) by (pod) /
            sum(container_spec_memory_limit_bytes{namespace="default",pod=~"transaction-api-.*"}) by (pod) * 100

        # Database connection pool utilization
        - record: resource:db_connection_pool:utilization_percentage
          expr: |
            db_connections_active{app="transaction-api"} /
            db_connections_max{app="transaction-api"} * 100

        # Average pod count
        - record: resource:pod_count:average
          expr: |
            avg(kube_deployment_status_replicas_available{deployment="transaction-api"})
